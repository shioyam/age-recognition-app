が、<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>年齢推定 AI - 画像から年齢を瞬時に分析</title>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; 
        font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; 
        img-src 'self' data: blob:; 
        connect-src 'self' https://cdn.jsdelivr.net https://unpkg.com;
        frame-ancestors 'none';
        base-uri 'self';
        form-action 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" 
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" 
          crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-user-clock"></i>
                        </div>
                        <h1 data-i18n="app.title">年齢推定 AI</h1>
                    </div>
                    <div class="language-selector">
                        <select id="languageSelect" class="language-select">
                            <option value="ja">🇯🇵 日本語</option>
                            <option value="en">🇺🇸 English</option>
                            <option value="ko">🇰🇷 한국어</option>
                            <option value="de">🇩🇪 Deutsch</option>
                        </select>
                    </div>
                </div>
                <p class="tagline" data-i18n="app.tagline">画像から顔を検出し、AIで年齢を瞬時に推定</p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Upload Section -->
            <section class="upload-section">
                <div class="upload-area">
                    <input type="file" id="imageInput" accept="image/*" class="file-input">
                    <label for="imageInput" class="upload-label">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h3 data-i18n="upload.title">画像をアップロード</h3>
                        <p data-i18n="upload.formats">JPG、PNG、WebP形式に対応</p>
                    </label>
                </div>
            </section>

            <!-- Image Preview -->
            <section id="imagePreview" class="image-preview hidden">
                <div class="image-container">
                    <img id="previewImg" alt="プレビュー">
                    <canvas id="overlayCanvas"></canvas>
                </div>
            </section>

            <!-- Initial Loading Status -->
            <section id="loading-status" class="loading-status">
                <div class="status-content">
                    <div class="status-icon">⏳</div>
                    <p id="status-message">AIライブラリを読み込み中...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>
            </section>

            <!-- Analysis Loading -->
            <section id="loading" class="loading hidden">
                <div class="loading-content">
                    <div class="spinner"></div>
                    <p data-i18n="loading.analyzing">AI分析中...</p>
                </div>
            </section>

            <!-- Results -->
            <section id="results" class="results hidden">
                <h2 data-i18n="results.title">分析結果</h2>
                <div id="resultContent"></div>
            </section>

            <!-- Features -->
            <section class="features">
                <h2 data-i18n="features.title">主な特徴</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 data-i18n="features.detection.title">高精度検出</h3>
                        <p data-i18n="features.detection.description">最新のAI技術で複数の顔を同時検出</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3 data-i18n="features.privacy.title">完全プライベート</h3>
                        <p data-i18n="features.privacy.description">ブラウザ内で処理、データは外部送信されません</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <h3 data-i18n="features.speed.title">高速処理</h3>
                        <p data-i18n="features.speed.description">リアルタイムで年齢・性別・表情を分析</p>
                    </div>
                </div>
            </section>

            <!-- Usage Guide -->
            <section class="guide">
                <h2 data-i18n="guide.title">使い方</h2>
                <div class="steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3 data-i18n="guide.step1.title">画像をアップロード</h3>
                            <p data-i18n="guide.step1.description">顔が写っている画像を選択してください</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3 data-i18n="guide.step2.title">AI分析開始</h3>
                            <p data-i18n="guide.step2.description">自動的に顔を検出して分析が始まります</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3 data-i18n="guide.step3.title">結果確認</h3>
                            <p data-i18n="guide.step3.description">推定年齢、性別、表情の結果を確認</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p><i class="fas fa-info-circle"></i> <span data-i18n="footer.privacy">このアプリはブラウザ上で動作し、画像は外部に送信されません</span></p>
                <p class="tech-note" data-i18n="footer.powered">Powered by TensorFlow.js & face-api.js</p>
            </div>
        </footer>
    </div>

    <script>
        // 改善されたface-api.js読み込みシステム
        let faceApiLoadAttempts = 0;
        let faceApiLoadStartTime = Date.now();
        
        const FACE_API_SOURCES = [
            {
                url: './libs/face-api.min.js',
                name: 'Local File (Fastest)',
                timeout: 3000,
                isLocal: true
            },
            {
                url: 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.min.js',
                name: 'jsDelivr CDN (Primary)',
                timeout: 10000
            },
            {
                url: 'https://unpkg.com/@vladmandic/face-api@1.7.12/dist/face-api.min.js',
                name: 'unpkg CDN',
                timeout: 8000
            },
            {
                url: 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js',
                name: 'face-api.js Original',
                timeout: 8000
            }
        ];

        function loadFaceApi(sourceIndex = 0) {
            if (sourceIndex >= FACE_API_SOURCES.length) {
                handleAllFaceApiSourcesFailed();
                return;
            }

            const source = FACE_API_SOURCES[sourceIndex];
            faceApiLoadAttempts++;
            
            console.log(`Loading face-api.js from ${source.name} (attempt ${faceApiLoadAttempts})`);
            
            const script = document.createElement('script');
            script.src = source.url;
            script.crossOrigin = 'anonymous';
            script.referrerPolicy = 'no-referrer';
            
            // タイムアウト処理
            const timeout = setTimeout(() => {
                console.warn(`${source.name} timed out after ${source.timeout}ms`);
                script.remove();
                loadFaceApi(sourceIndex + 1);
            }, source.timeout);
            
            script.onload = function() {
                clearTimeout(timeout);
                const loadTime = Date.now() - faceApiLoadStartTime;
                console.log(`✅ face-api.js loaded successfully from ${source.name} in ${loadTime}ms`);
                
                // face-api.jsが正常に読み込まれたかチェック
                if (typeof faceapi !== 'undefined') {
                    showLoadingStatus(`AIライブラリが正常に読み込まれました (${loadTime}ms)`);
                } else {
                    console.error('face-api.js loaded but faceapi object is undefined');
                    loadFaceApi(sourceIndex + 1);
                }
            };
            
            script.onerror = function() {
                clearTimeout(timeout);
                console.error(`❌ Failed to load from ${source.name}`);
                loadFaceApi(sourceIndex + 1);
            };
            
            document.head.appendChild(script);
        }

        function handleFaceApiLoadError() {
            // レガシー関数 - 新しいシステムで処理
            loadFaceApi(1);
        }
        
        function handleAllFaceApiSourcesFailed() {
            const totalTime = Date.now() - faceApiLoadStartTime;
            console.error(`❌ All face-api.js sources failed after ${faceApiLoadAttempts} attempts in ${totalTime}ms`);
            
            showLoadingError({
                title: 'AIライブラリの読み込みに失敗しました',
                message: 'すべてのCDNソースから読み込みに失敗しました。',
                attempts: faceApiLoadAttempts,
                totalTime: totalTime,
                suggestions: [
                    'インターネット接続を確認してください',
                    'ファイアウォールまたは広告ブロッカーを確認してください', 
                    'VPNを使用している場合は無効にしてください',
                    'ブラウザのキャッシュをクリアしてください',
                    '別のブラウザでお試しください'
                ]
            });
        }

        function showLoadingStatus(message, progress = 100) {
            const statusDiv = document.getElementById('loading-status');
            const statusMessage = document.getElementById('status-message');
            const progressFill = document.getElementById('progress-fill');
            
            if (statusDiv && statusMessage && progressFill) {
                statusMessage.textContent = message;
                progressFill.style.width = `${progress}%`;
                
                if (progress === 100) {
                    statusDiv.style.background = 'rgba(16, 185, 129, 0.1)';
                    statusMessage.style.color = '#059669';
                    setTimeout(() => {
                        statusDiv.style.opacity = '0';
                        setTimeout(() => statusDiv.style.display = 'none', 300);
                    }, 2000);
                }
            }
        }
        
        function updateLoadingProgress(stage, progress) {
            const statusMessage = document.getElementById('status-message');
            const progressFill = document.getElementById('progress-fill');
            
            const stages = {
                'library': { message: 'AIライブラリを読み込み中...', baseProgress: 0 },
                'models': { message: 'AIモデルを読み込み中...', baseProgress: 30 },
                'ready': { message: '準備完了', baseProgress: 100 }
            };
            
            if (statusMessage && progressFill && stages[stage]) {
                const stageInfo = stages[stage];
                const totalProgress = stageInfo.baseProgress + (progress * (stage === 'library' ? 30 : stage === 'models' ? 70 : 0) / 100);
                
                statusMessage.textContent = stageInfo.message;
                progressFill.style.width = `${Math.min(totalProgress, 100)}%`;
            }
        }

        function showLoadingError(errorInfo) {
            // より詳細なエラー情報を表示
            const resultsDiv = document.getElementById('results');
            if (resultsDiv) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #fee 0%, #fdd 100%); border-radius: 12px; border: 2px solid #f87171; box-shadow: 0 4px 12px rgba(248, 113, 113, 0.15);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                        <h3 style="color: #dc2626; margin-bottom: 1rem;">${errorInfo.title}</h3>
                        <p style="color: #7f1d1d; margin-bottom: 1rem;">${errorInfo.message}</p>
                        <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 8px; margin: 1rem 0; font-size: 0.9rem;">
                            <strong>技術情報:</strong> ${errorInfo.attempts}回の試行で${errorInfo.totalTime}ms経過
                        </div>
                        <div style="text-align: left; max-width: 500px; margin: 1.5rem auto;">
                            <h4 style="color: #dc2626; margin-bottom: 0.5rem;">解決策:</h4>
                            <ul style="padding-left: 1.5rem;">
                                ${errorInfo.suggestions.map(suggestion => `<li style="margin-bottom: 0.5rem;">${suggestion}</li>`).join('')}
                            </ul>
                        </div>
                        <div style="margin-top: 2rem;">
                            <button onclick="retryFaceApiLoad()" style="margin: 0.5rem; padding: 0.75rem 1.5rem; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                🔄 再試行
                            </button>
                            <button onclick="location.reload()" style="margin: 0.5rem; padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                🔃 ページを再読み込み
                            </button>
                        </div>
                    </div>
                `;
                resultsDiv.classList.remove('hidden');
            }
        }

        function retryFaceApiLoad() {
            faceApiLoadAttempts = 0;
            faceApiLoadStartTime = Date.now();
            const resultsDiv = document.getElementById('results');
            if (resultsDiv) {
                resultsDiv.innerHTML = '<p>AIライブラリを再読み込み中...</p>';
            }
            loadFaceApi(0);
        }

        // 初期読み込み開始
        document.addEventListener('DOMContentLoaded', function() {
            updateLoadingProgress('library', 0);
            loadFaceApi(0);
        });
    </script>
    <script src="security-check.js"></script>
    <script src="script.js"></script>
</body>
</html>
