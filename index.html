ãŒã€<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹´é½¢æ¨å®š AI - ç”»åƒã‹ã‚‰å¹´é½¢ã‚’ç¬æ™‚ã«åˆ†æ</title>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; 
        font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; 
        img-src 'self' data: blob:; 
        connect-src 'self' https://cdn.jsdelivr.net https://unpkg.com;
        frame-ancestors 'none';
        base-uri 'self';
        form-action 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" 
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" 
          crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-user-clock"></i>
                        </div>
                        <h1 data-i18n="app.title">å¹´é½¢æ¨å®š AI</h1>
                    </div>
                    <div class="language-selector">
                        <select id="languageSelect" class="language-select">
                            <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                            <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                            <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                            <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                        </select>
                    </div>
                </div>
                <p class="tagline" data-i18n="app.tagline">ç”»åƒã‹ã‚‰é¡”ã‚’æ¤œå‡ºã—ã€AIã§å¹´é½¢ã‚’ç¬æ™‚ã«æ¨å®š</p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Upload Section -->
            <section class="upload-section">
                <div class="upload-area">
                    <input type="file" id="imageInput" accept="image/*" class="file-input">
                    <label for="imageInput" class="upload-label">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h3 data-i18n="upload.title">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                        <p data-i18n="upload.formats">JPGã€PNGã€WebPå½¢å¼ã«å¯¾å¿œ</p>
                    </label>
                </div>
            </section>

            <!-- Image Preview -->
            <section id="imagePreview" class="image-preview hidden">
                <div class="image-container">
                    <img id="previewImg" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                    <canvas id="overlayCanvas"></canvas>
                </div>
            </section>

            <!-- Initial Loading Status -->
            <section id="loading-status" class="loading-status">
                <div class="status-content">
                    <div class="status-icon">â³</div>
                    <p id="status-message">AIãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>
            </section>

            <!-- Analysis Loading -->
            <section id="loading" class="loading hidden">
                <div class="loading-content">
                    <div class="spinner"></div>
                    <p data-i18n="loading.analyzing">AIåˆ†æä¸­...</p>
                </div>
            </section>

            <!-- Results -->
            <section id="results" class="results hidden">
                <h2 data-i18n="results.title">åˆ†æçµæœ</h2>
                <div id="resultContent"></div>
            </section>

            <!-- Features -->
            <section class="features">
                <h2 data-i18n="features.title">ä¸»ãªç‰¹å¾´</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 data-i18n="features.detection.title">é«˜ç²¾åº¦æ¤œå‡º</h3>
                        <p data-i18n="features.detection.description">æœ€æ–°ã®AIæŠ€è¡“ã§è¤‡æ•°ã®é¡”ã‚’åŒæ™‚æ¤œå‡º</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3 data-i18n="features.privacy.title">å®Œå…¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ</h3>
                        <p data-i18n="features.privacy.description">ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å‡¦ç†ã€ãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨é€ä¿¡ã•ã‚Œã¾ã›ã‚“</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <h3 data-i18n="features.speed.title">é«˜é€Ÿå‡¦ç†</h3>
                        <p data-i18n="features.speed.description">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¹´é½¢ãƒ»æ€§åˆ¥ãƒ»è¡¨æƒ…ã‚’åˆ†æ</p>
                    </div>
                </div>
            </section>

            <!-- Usage Guide -->
            <section class="guide">
                <h2 data-i18n="guide.title">ä½¿ã„æ–¹</h2>
                <div class="steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3 data-i18n="guide.step1.title">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                            <p data-i18n="guide.step1.description">é¡”ãŒå†™ã£ã¦ã„ã‚‹ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3 data-i18n="guide.step2.title">AIåˆ†æé–‹å§‹</h3>
                            <p data-i18n="guide.step2.description">è‡ªå‹•çš„ã«é¡”ã‚’æ¤œå‡ºã—ã¦åˆ†æãŒå§‹ã¾ã‚Šã¾ã™</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3 data-i18n="guide.step3.title">çµæœç¢ºèª</h3>
                            <p data-i18n="guide.step3.description">æ¨å®šå¹´é½¢ã€æ€§åˆ¥ã€è¡¨æƒ…ã®çµæœã‚’ç¢ºèª</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p><i class="fas fa-info-circle"></i> <span data-i18n="footer.privacy">ã“ã®ã‚¢ãƒ—ãƒªã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‹•ä½œã—ã€ç”»åƒã¯å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“</span></p>
                <p class="tech-note" data-i18n="footer.powered">Powered by TensorFlow.js & face-api.js</p>
            </div>
        </footer>
    </div>

    <script>
        // æ”¹å–„ã•ã‚ŒãŸface-api.jsèª­ã¿è¾¼ã¿ã‚·ã‚¹ãƒ†ãƒ 
        let faceApiLoadAttempts = 0;
        let faceApiLoadStartTime = Date.now();
        
        const FACE_API_SOURCES = [
            {
                url: './libs/face-api.min.js',
                name: 'Local File (Fastest)',
                timeout: 3000,
                isLocal: true
            },
            {
                url: 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.min.js',
                name: 'jsDelivr CDN (Primary)',
                timeout: 10000
            },
            {
                url: 'https://unpkg.com/@vladmandic/face-api@1.7.12/dist/face-api.min.js',
                name: 'unpkg CDN',
                timeout: 8000
            },
            {
                url: 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js',
                name: 'face-api.js Original',
                timeout: 8000
            }
        ];

        function loadFaceApi(sourceIndex = 0) {
            if (sourceIndex >= FACE_API_SOURCES.length) {
                handleAllFaceApiSourcesFailed();
                return;
            }

            const source = FACE_API_SOURCES[sourceIndex];
            faceApiLoadAttempts++;
            
            console.log(`Loading face-api.js from ${source.name} (attempt ${faceApiLoadAttempts})`);
            
            const script = document.createElement('script');
            script.src = source.url;
            script.crossOrigin = 'anonymous';
            script.referrerPolicy = 'no-referrer';
            
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
            const timeout = setTimeout(() => {
                console.warn(`${source.name} timed out after ${source.timeout}ms`);
                script.remove();
                loadFaceApi(sourceIndex + 1);
            }, source.timeout);
            
            script.onload = function() {
                clearTimeout(timeout);
                const loadTime = Date.now() - faceApiLoadStartTime;
                console.log(`âœ… face-api.js loaded successfully from ${source.name} in ${loadTime}ms`);
                
                // face-api.jsãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
                if (typeof faceapi !== 'undefined') {
                    showLoadingStatus(`AIãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ (${loadTime}ms)`);
                } else {
                    console.error('face-api.js loaded but faceapi object is undefined');
                    loadFaceApi(sourceIndex + 1);
                }
            };
            
            script.onerror = function() {
                clearTimeout(timeout);
                console.error(`âŒ Failed to load from ${source.name}`);
                loadFaceApi(sourceIndex + 1);
            };
            
            document.head.appendChild(script);
        }

        function handleFaceApiLoadError() {
            // ãƒ¬ã‚¬ã‚·ãƒ¼é–¢æ•° - æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ã§å‡¦ç†
            loadFaceApi(1);
        }
        
        function handleAllFaceApiSourcesFailed() {
            const totalTime = Date.now() - faceApiLoadStartTime;
            console.error(`âŒ All face-api.js sources failed after ${faceApiLoadAttempts} attempts in ${totalTime}ms`);
            
            showLoadingError({
                title: 'AIãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ',
                message: 'ã™ã¹ã¦ã®CDNã‚½ãƒ¼ã‚¹ã‹ã‚‰èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
                attempts: faceApiLoadAttempts,
                totalTime: totalTime,
                suggestions: [
                    'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„',
                    'ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã¾ãŸã¯åºƒå‘Šãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„', 
                    'VPNã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ç„¡åŠ¹ã«ã—ã¦ãã ã•ã„',
                    'ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„',
                    'åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ãŠè©¦ã—ãã ã•ã„'
                ]
            });
        }

        function showLoadingStatus(message, progress = 100) {
            const statusDiv = document.getElementById('loading-status');
            const statusMessage = document.getElementById('status-message');
            const progressFill = document.getElementById('progress-fill');
            
            if (statusDiv && statusMessage && progressFill) {
                statusMessage.textContent = message;
                progressFill.style.width = `${progress}%`;
                
                if (progress === 100) {
                    statusDiv.style.background = 'rgba(16, 185, 129, 0.1)';
                    statusMessage.style.color = '#059669';
                    setTimeout(() => {
                        statusDiv.style.opacity = '0';
                        setTimeout(() => statusDiv.style.display = 'none', 300);
                    }, 2000);
                }
            }
        }
        
        function updateLoadingProgress(stage, progress) {
            const statusMessage = document.getElementById('status-message');
            const progressFill = document.getElementById('progress-fill');
            
            const stages = {
                'library': { message: 'AIãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ä¸­...', baseProgress: 0 },
                'models': { message: 'AIãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...', baseProgress: 30 },
                'ready': { message: 'æº–å‚™å®Œäº†', baseProgress: 100 }
            };
            
            if (statusMessage && progressFill && stages[stage]) {
                const stageInfo = stages[stage];
                const totalProgress = stageInfo.baseProgress + (progress * (stage === 'library' ? 30 : stage === 'models' ? 70 : 0) / 100);
                
                statusMessage.textContent = stageInfo.message;
                progressFill.style.width = `${Math.min(totalProgress, 100)}%`;
            }
        }

        function showLoadingError(errorInfo) {
            // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            const resultsDiv = document.getElementById('results');
            if (resultsDiv) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #fee 0%, #fdd 100%); border-radius: 12px; border: 2px solid #f87171; box-shadow: 0 4px 12px rgba(248, 113, 113, 0.15);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
                        <h3 style="color: #dc2626; margin-bottom: 1rem;">${errorInfo.title}</h3>
                        <p style="color: #7f1d1d; margin-bottom: 1rem;">${errorInfo.message}</p>
                        <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 8px; margin: 1rem 0; font-size: 0.9rem;">
                            <strong>æŠ€è¡“æƒ…å ±:</strong> ${errorInfo.attempts}å›ã®è©¦è¡Œã§${errorInfo.totalTime}msçµŒé
                        </div>
                        <div style="text-align: left; max-width: 500px; margin: 1.5rem auto;">
                            <h4 style="color: #dc2626; margin-bottom: 0.5rem;">è§£æ±ºç­–:</h4>
                            <ul style="padding-left: 1.5rem;">
                                ${errorInfo.suggestions.map(suggestion => `<li style="margin-bottom: 0.5rem;">${suggestion}</li>`).join('')}
                            </ul>
                        </div>
                        <div style="margin-top: 2rem;">
                            <button onclick="retryFaceApiLoad()" style="margin: 0.5rem; padding: 0.75rem 1.5rem; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ğŸ”„ å†è©¦è¡Œ
                            </button>
                            <button onclick="location.reload()" style="margin: 0.5rem; padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ğŸ”ƒ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
                            </button>
                        </div>
                    </div>
                `;
                resultsDiv.classList.remove('hidden');
            }
        }

        function retryFaceApiLoad() {
            faceApiLoadAttempts = 0;
            faceApiLoadStartTime = Date.now();
            const resultsDiv = document.getElementById('results');
            if (resultsDiv) {
                resultsDiv.innerHTML = '<p>AIãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å†èª­ã¿è¾¼ã¿ä¸­...</p>';
            }
            loadFaceApi(0);
        }

        // åˆæœŸèª­ã¿è¾¼ã¿é–‹å§‹
        document.addEventListener('DOMContentLoaded', function() {
            updateLoadingProgress('library', 0);
            loadFaceApi(0);
        });
    </script>
    <script src="security-check.js"></script>
    <script src="script.js"></script>
</body>
</html>
